name: Build & Deploy Dashboard Frontend (Pi Runner)

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'static/**'
      - 'package.json'
      - 'package-lock.json'
      - 'svelte.config.js'
      - 'vite.config.*'
      - '.github/workflows/deploy.yml'

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      DASHBOARD_ENV_PATH: /home/arnaud/dashboard_api/dashboard.env # Env file path

    steps:
      - name: Load shared env vars from Pi
        run: |
          set -a
          source "$DASHBOARD_ENV_PATH"
          set +a

          # Expose backend-style vars
          env | grep -E '^DASHBOARD_' >> "$GITHUB_ENV"

          # Expose Vite vars
          echo "VITE_DASHBOARD_API_URL=$DASHBOARD_API_URL" >> "$GITHUB_ENV"
          echo "VITE_DASHBOARD_USER=$DASHBOARD_USER" >> "$GITHUB_ENV"
          echo "VITE_DASHBOARD_PASSWORD=$DASHBOARD_PASSWORD" >> "$GITHUB_ENV"

      - name: Sync frontend repo on the Pi
        run: |
          cd "$DASHBOARD_FRONT_ROOT_DIR"
          git fetch origin
          git reset --hard origin/master

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd "$DASHBOARD_FRONT_ROOT_DIR"
          npm ci

      - name: Build frontend
        run: |
          cd "$DASHBOARD_FRONT_ROOT_DIR"
          npm run build

      - name: Deploy build to backend public dir
        run: |
          rm -rf "$DASHBOARD_API_ROOT_DIR/public"
          mkdir -p "$DASHBOARD_API_ROOT_DIR/public"
          cp -r "$DASHBOARD_FRONT_ROOT_DIR/build/"* "$DASHBOARD_API_ROOT_DIR/public/"

      - name: Restart backend service
        run: |
          sudo systemctl restart "$DASHBOARD_API_SERVICE"
